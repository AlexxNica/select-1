<!DOCTYPE html>

<html>
<head>
  <title>select.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>select.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>DropSelect = Drop.createContext()

ENTER = <span class="number">13</span>
ESCAPE = <span class="number">27</span>
SPACE = <span class="number">32</span>
UP = <span class="number">38</span>
DOWN = <span class="number">40</span>

<span class="function"><span class="title">strIsRepeatedCharacter</span></span> = (str) -&gt;
    <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">unless</span> str.length &gt; <span class="number">1</span>
    letter = str.charAt <span class="number">0</span>
    <span class="keyword">for</span> char <span class="keyword">in</span> str.split <span class="string">''</span>
        <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> char <span class="keyword">isnt</span> letter
    <span class="keyword">return</span> <span class="literal">true</span>

<span class="function"><span class="title">getFocusedSelect</span></span> = -&gt;
    $focusedTarget = $(<span class="string">'.select-target-focused:first'</span>)
    <span class="keyword">return</span> $focusedTarget?.length <span class="keyword">and</span> $focusedTarget.data(<span class="string">'select'</span>)

searchText = <span class="string">''</span>
searchTextTimeout = <span class="literal">undefined</span>

lastCharacter = <span class="literal">undefined</span>

$(window).<span class="literal">on</span> <span class="string">'keypress'</span>, (e) -&gt;
    select = getFocusedSelect()
    <span class="keyword">return</span> <span class="keyword">unless</span> select

    <span class="keyword">return</span> <span class="keyword">if</span> e.charCode <span class="keyword">is</span> <span class="number">0</span>

    newCharacter = String.fromCharCode e.charCode

    <span class="keyword">if</span> strIsRepeatedCharacter(searchText) <span class="keyword">and</span> <span class="keyword">not</span> strIsRepeatedCharacter(searchText + newCharacter)
        searchText = newCharacter
    <span class="keyword">else</span>
        searchText += newCharacter
        searchText += newCharacter <span class="keyword">if</span> lastCharacter <span class="keyword">is</span> newCharacter

    lastCharacter = newCharacter

    <span class="keyword">if</span> e.keyCode <span class="keyword">is</span> SPACE
        e.preventDefault()

    <span class="keyword">if</span> select.dropSelect.isOpened()
        select.highlightOptionByText searchText
    <span class="keyword">else</span>
        select.selectOptionByText searchText

    clearTimeout searchTextTimeout
    searchTextTimeout = setTimeout -&gt;
        searchText = <span class="string">''</span>
    , <span class="number">500</span>

$(window).<span class="literal">on</span> <span class="string">'keydown'</span>, (e) -&gt;
    select = getFocusedSelect()
    <span class="keyword">return</span> <span class="keyword">unless</span> select

    <span class="keyword">if</span> e.keyCode <span class="keyword">in</span> [UP, DOWN, ESCAPE]
        e.preventDefault()

    <span class="keyword">if</span> select.dropSelect.isOpened()
        <span class="keyword">switch</span> e.keyCode
            <span class="keyword">when</span> UP, DOWN
                select.moveHighlight e.keyCode
            <span class="keyword">when</span> ENTER
                select.selectHighlightedOption()
            <span class="keyword">when</span> ESCAPE
                select.dropSelect.close()
                select.$target.focus()
    <span class="keyword">else</span>
        <span class="keyword">if</span> e.keyCode <span class="keyword">in</span> [UP, DOWN, SPACE]
            select.dropSelect.open()

<span class="class"><span class="keyword">class</span> <span class="title">Select</span></span>

    <span class="property">@defaults</span>:
        selectLikeAlignment: <span class="string">'auto'</span>
        className: <span class="string">'select-theme-default'</span>

    constructor: (<span class="property">@options</span>) -&gt;
        <span class="property">@options</span> = $.extend {}, Select.defaults, <span class="property">@options</span>
        <span class="property">@$select</span> = $ <span class="property">@options</span>.el

        <span class="property">@setupTarget</span>()
        <span class="property">@renderTarget</span>()

        <span class="property">@setupDrop</span>()
        <span class="property">@renderDrop</span>()

        <span class="property">@setupSelect</span>()

    setupTarget: -&gt;
        $options = <span class="property">@$select</span>.find(<span class="string">'option'</span>)

        <span class="property">@$target</span> = $ <span class="string">"""&lt;a href="javascript:;" class="select-target <span class="subst">#{ @options.className }</span>"&gt;&lt;/a&gt;"""</span>

        <span class="property">@$target</span>.data <span class="string">'select'</span>, @

        <span class="property">@$target</span>.<span class="literal">on</span> <span class="string">'click'</span>, =&gt;
            <span class="keyword">if</span> <span class="keyword">not</span> <span class="property">@dropSelect</span>.isOpened()
                <span class="property">@$target</span>.focus()
            <span class="keyword">else</span>
                <span class="property">@$target</span>.blur()

        <span class="property">@$target</span>.<span class="literal">on</span> <span class="string">'focus'</span>, =&gt;
            <span class="property">@$target</span>.addClass(<span class="string">'select-target-focused'</span>)

        <span class="property">@$target</span>.<span class="literal">on</span> <span class="string">'blur'</span>, (e) =&gt;
            <span class="keyword">if</span> <span class="property">@dropSelect</span>.isOpened()
                <span class="keyword">if</span> e.relatedTarget <span class="keyword">and</span> <span class="keyword">not</span> $(e.relatedTarget).parents(<span class="string">'.drop:first'</span>).<span class="keyword">is</span>(<span class="property">@dropSelect</span>.$drop)
                    <span class="property">@dropSelect</span>.close()
            <span class="keyword">else</span>
                <span class="property">@$target</span>.removeClass(<span class="string">'select-target-focused'</span>)

        <span class="property">@$select</span>.after(<span class="property">@$target</span>).hide()

    renderTarget: -&gt;
        <span class="property">@$target</span>.text <span class="property">@$select</span>.find(<span class="string">'option:selected'</span>).text()
        <span class="property">@$target</span>.append <span class="string">'&lt;b&gt;&lt;/b&gt;'</span>

    setupDrop: -&gt;
        <span class="property">@dropSelect</span> = <span class="keyword">new</span> DropSelect
            target: <span class="property">@$target</span>[<span class="number">0</span>]
            className: <span class="property">@options</span>.className
            attach: <span class="string">'bottom left'</span>
            constrainToWindow: <span class="literal">true</span>
            constrainToScrollParent: <span class="literal">false</span>
            openOn: <span class="string">'click'</span>

        <span class="property">@dropSelect</span>.$drop.<span class="literal">on</span> <span class="string">'click'</span>, <span class="string">'.select-option'</span>, (e) =&gt;
            <span class="property">@selectOption</span> e.target

        <span class="property">@dropSelect</span>.$drop.<span class="literal">on</span> <span class="string">'mousemove'</span>, <span class="string">'.select-option'</span>, (e) =&gt;
            <span class="property">@highlightOption</span> e.target

        <span class="property">@dropSelect</span>.$drop.<span class="literal">on</span> <span class="string">'dropopen'</span>, =&gt;
            $selectedOption = <span class="property">@dropSelect</span>.$drop.find(<span class="string">'[data-selected="true"]'</span>)
            $content = <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.drop-content'</span>)

            <span class="function"><span class="title">positionSelectStyle</span></span> = =&gt;
                <span class="keyword">if</span> <span class="property">@dropSelect</span>.$drop.hasClass(<span class="string">'tether-abutted-left tether-abutted-bottom'</span>)
                    offset = <span class="property">@dropSelect</span>.$drop.offset().top - ($selectedOption.offset().top + $selectedOption.outerHeight())
                    <span class="property">@dropSelect</span>.$drop.css top: <span class="string">"+=<span class="subst">#{ offset }</span>"</span>

            <span class="property">@highlightOption</span> $selectedOption[<span class="number">0</span>]
            <span class="property">@scrollDropContentToOption</span> $selectedOption[<span class="number">0</span>]

            <span class="keyword">if</span> <span class="property">@options</span>.selectLikeAlignment <span class="keyword">is</span> <span class="string">'always'</span> <span class="keyword">or</span> (<span class="property">@options</span>.selectLikeAlignment <span class="keyword">is</span> <span class="string">'auto'</span> <span class="keyword">and</span> $content[<span class="number">0</span>].scrollHeight &lt;= $content[<span class="number">0</span>].clientHeight)
                setTimeout positionSelectStyle

        <span class="property">@dropSelect</span>.$drop.<span class="literal">on</span> <span class="string">'dropclose'</span>, =&gt;
            <span class="property">@$target</span>.removeClass(<span class="string">'select-target-focused'</span>)

    renderDrop: -&gt;
        $dropSelectOptions = $ <span class="string">'&lt;ul class="select-options"&gt;&lt;/ul&gt;'</span>

        <span class="property">@$select</span>.find(<span class="string">'option'</span>).each -&gt;
            $option = $ @
            $dropSelectOptions.append <span class="string">"""&lt;li data-selected="<span class="subst">#{ $option.<span class="keyword">is</span>(':selected') }</span>" class="select-option" data-value="<span class="subst">#{ @value }</span>"&gt;<span class="subst">#{ $option.text() }</span>&lt;/li&gt;"""</span>

        <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.drop-content'</span>).html $dropSelectOptions[<span class="number">0</span>]

    setupSelect: -&gt;
        <span class="property">@$select</span>.data <span class="string">'select'</span>, @

        <span class="property">@$select</span>.<span class="literal">on</span> <span class="string">'change'</span>, =&gt;
            <span class="property">@renderDrop</span>()
            <span class="property">@renderTarget</span>()

    selectOptionByText: (text) -&gt;
        options = <span class="property">@$select</span>.find(<span class="string">'option'</span>).toArray()
        currentHighlightedIndex = <span class="property">@$select</span>.find(<span class="string">'option:selected'</span>).index()
        <span class="keyword">return</span> <span class="keyword">unless</span> currentHighlightedIndex?

        isRepeatedCharacter = strIsRepeatedCharacter text

        i = currentHighlightedIndex
        i += <span class="number">1</span> <span class="keyword">if</span> isRepeatedCharacter

        optionsChecked = <span class="number">0</span>

        <span class="keyword">while</span> optionsChecked &lt; options.length
            i = <span class="number">0</span> <span class="keyword">if</span> i &gt; options.length - <span class="number">1</span>
            option = options[i]
            $option = $ option

            <span class="keyword">if</span> (isRepeatedCharacter <span class="keyword">and</span> $option.text().toLowerCase().charAt(<span class="number">0</span>) <span class="keyword">is</span> text.toLowerCase().charAt(<span class="number">0</span>)) <span class="keyword">or</span> $option.text().toLowerCase().substr(<span class="number">0</span>, text.length) <span class="keyword">is</span> text.toLowerCase()
                <span class="property">@$select</span>.val($option.val()).change()
                <span class="keyword">return</span>

            optionsChecked += <span class="number">1</span>
            i += <span class="number">1</span>

    highlightOptionByText: (text) -&gt;
        <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@dropSelect</span>.isOpened()

        options = <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.select-option'</span>).toArray()
        currentHighlightedIndex = <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.select-option-highlight'</span>).index()
        <span class="keyword">return</span> <span class="keyword">unless</span> currentHighlightedIndex?

        isRepeatedCharacter = strIsRepeatedCharacter text

        i = currentHighlightedIndex
        i += <span class="number">1</span> <span class="keyword">if</span> isRepeatedCharacter

        optionsChecked = <span class="number">0</span>

        <span class="keyword">while</span> optionsChecked &lt; options.length
            i = <span class="number">0</span> <span class="keyword">if</span> i &gt; options.length - <span class="number">1</span>
            option = options[i]
            $option = $ option

            <span class="keyword">if</span> (isRepeatedCharacter <span class="keyword">and</span> $option.text().toLowerCase().charAt(<span class="number">0</span>) <span class="keyword">is</span> text.toLowerCase().charAt(<span class="number">0</span>)) <span class="keyword">or</span> $option.text().toLowerCase().substr(<span class="number">0</span>, text.length) <span class="keyword">is</span> text.toLowerCase()
                <span class="property">@highlightOption</span> option
                <span class="property">@scrollDropContentToOption</span> option
                <span class="keyword">return</span>

            optionsChecked += <span class="number">1</span>
            i += <span class="number">1</span>

    highlightOption: (option) -&gt;
        <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.select-option-highlight'</span>).removeClass(<span class="string">'select-option-highlight'</span>)
        $(option).addClass(<span class="string">'select-option-highlight'</span>)

    moveHighlight: (directionKeyCode) -&gt;
        $currentHighlight = <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.select-option-highlight'</span>)

        <span class="keyword">if</span> <span class="keyword">not</span> $currentHighlight.length
            <span class="keyword">return</span> <span class="property">@highlightOption</span> <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.select-option:first'</span>)

        $newHighlight = <span class="keyword">if</span> directionKeyCode <span class="keyword">is</span> UP <span class="keyword">then</span> $currentHighlight.prev() <span class="keyword">else</span> $currentHighlight.next()
        <span class="keyword">return</span> <span class="keyword">unless</span> $newHighlight.length

        <span class="property">@highlightOption</span> $newHighlight[<span class="number">0</span>]
        <span class="property">@scrollDropContentToOption</span> $newHighlight[<span class="number">0</span>]

    scrollDropContentToOption: (option) -&gt;
        $option = $ option
        $content = <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.drop-content'</span>)

        <span class="keyword">if</span> $content[<span class="number">0</span>].scrollHeight &gt; $content[<span class="number">0</span>].clientHeight
            $content.scrollTop $option.offset().top - ($content.offset().top - $content.scrollTop())

    selectHighlightedOption: -&gt;
        <span class="property">@selectOption</span> <span class="property">@dropSelect</span>.$drop.find(<span class="string">'.select-option-highlight'</span>)[<span class="number">0</span>]

    selectOption: (option) -&gt;
        <span class="property">@$select</span>.val($(option).data(<span class="string">'value'</span>)).change()

        setTimeout (=&gt;
            <span class="property">@dropSelect</span>.close()
            <span class="property">@$target</span>.focus()
        ), <span class="number">0</span>

window.Select = Select</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
